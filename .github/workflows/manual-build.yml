name: Manual Build All Platforms

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  packages: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            name: ResearchBuddy-5.1.1-linux
            archive: tar.gz
          - os: windows-latest  
            platform: windows
            name: ResearchBuddy-5.1.1-windows
            archive: zip
          - os: macos-latest
            platform: macos
            name: ResearchBuddy-5.1.1-macos
            archive: zip

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Python for macOS
      if: matrix.os == 'macos-latest'
      run: |
        # Building for native architecture (ARM64)
        # Will run on Intel Macs via Rosetta 2
        python --version
        python -c "import platform; print(f'Architecture: {platform.machine()}')"
        
    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1 \
          libxrandr2 \
          libxss1 \
          libxcursor1 \
          libxcomposite1 \
          libasound2t64 \
          libxi6 \
          libxtst6 \
          libfontconfig1 \
          libxrender1 \
          libdbus-1-3 \
          libxkbcommon-x11-0 \
          libxkbcommon0
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        python -m PyInstaller build_files/ResearchBuddy5.1.1.spec --distpath ./dist --workpath ./build --clean --noconfirm
        
    - name: Create distribution package
      shell: bash
      run: |
        mkdir -p releases
        
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          # Windows: Create ZIP using PowerShell
          cd dist
          powershell -Command "Compress-Archive -Path ResearchBuddy5.1.1 -DestinationPath ../releases/${{ matrix.name }}.zip -Force"
          cd ..
          echo "✅ Created ${{ matrix.name }}.zip"
          ls -lh releases/
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          # macOS: Create professional DMG installer
          
          # First verify .app was created
          if [ ! -d "dist/ResearchBuddy5.1.1.app" ]; then
            echo "❌ Error: .app bundle not found"
            ls -la dist/
            exit 1
          fi
          
          # Create DMG temp directory
          mkdir -p dmg-temp
          cp -R dist/ResearchBuddy5.1.1.app dmg-temp/
          ln -s /Applications dmg-temp/Applications
          
          # Copy Quick Start guide if available
          if [ -f "docs/QUICK_START_FOR_GAS.md" ]; then
            cp docs/QUICK_START_FOR_GAS.md dmg-temp/"Quick Start Guide.md"
          fi
          
          # Create the DMG
          hdiutil create \
            -volname "ResearchBuddy 5.1.1" \
            -srcfolder dmg-temp \
            -ov -format UDZO \
            releases/${{ matrix.name }}.dmg
          
          # Clean up
          rm -rf dmg-temp
          
          echo "✅ Created ${{ matrix.name }}.dmg"
          ls -lh releases/
        else
          # Linux: Create AppImage only (universal Linux distribution)
          bash build_files/create_appimage.sh
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: releases/*
        retention-days: 90

  create-release:
    needs: build
    runs-on: ubuntu-latest
    # Only run if all build jobs succeeded
    if: ${{ github.event_name == 'workflow_dispatch' && success() }}
    permissions:
      contents: write
    
    steps:
    - name: Check build status
      run: |
        echo "All build jobs completed. Proceeding with release..."
        
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display and flatten artifacts
      run: |
        echo "📦 Downloaded artifacts structure:"
        ls -R artifacts
        
        echo ""
        echo "📂 Searching for release files..."
        find artifacts -type f
        
        echo ""
        echo "📂 Flattening structure..."
        mkdir -p release-files
        
        # Copy each artifact type with feedback
        echo "Looking for .zip files..."
        find artifacts -type f -name "*.zip" -exec cp -v {} release-files/ \;
        
        echo "Looking for .tar.gz files..."
        find artifacts -type f -name "*.tar.gz" -exec cp -v {} release-files/ \;
        
        echo "Looking for .dmg files..."
        find artifacts -type f -name "*.dmg" -exec cp -v {} release-files/ \;
        
        echo "Looking for .AppImage files..."
        find artifacts -type f -name "*.AppImage" -exec cp -v {} release-files/ \;
        
        echo ""
        echo "✅ Files ready for release:"
        ls -lh release-files/
        
        # Verify we have files and list exactly what we found
        if [ -z "$(ls -A release-files/)" ]; then
          echo "❌ ERROR: No files found in release-files directory!"
          exit 1
        fi
        
        echo ""
        echo "📋 Exact files to upload:"
        find release-files -type f -exec basename {} \;

    - name: Checkout code (for tagging)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ github.token }}

    - name: Create or verify tag
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        if git rev-parse v5.1.1 >/dev/null 2>&1; then
          echo "✅ Tag v5.1.1 already exists"
        else
          echo "📝 Creating tag v5.1.1"
          git tag -a v5.1.1 -m "Release v5.1.1"
          git push origin v5.1.1
        fi
    
    - name: Delete existing release (to refresh files)
      continue-on-error: true
      run: |
        gh release delete v5.1.1 --yes || echo "No existing release to delete"
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v5.1.1
        name: Research Buddy 5.1.1 - Professional Cross-Platform Installers
        draft: false
        prerelease: false
        make_latest: true
        files: release-files/*
        fail_on_unmatched_files: true
        generate_release_notes: false
        body: |
          # 🚀 Research Buddy 5.1.1 - Professional Cross-Platform Release
          
          **Professional installers for all platforms - just download and run!**
          
          ## 📥 Downloads
          
          ### macOS 🍎
          **ResearchBuddy-5.1.1-macos.dmg**
          - Double-click DMG → Drag app to Applications → Done!
          - Works on both Intel and Apple Silicon Macs
          
          ### Windows 🪟
          **ResearchBuddy-5.1.1-windows.zip**
          - Extract → Double-click `.exe` → Run!
          - If Windows Defender warns: Click "More info" → "Run anyway"
          
          ### Linux 🐧
          **ResearchBuddy-5.1.1-x86_64.AppImage**
          - `chmod +x ResearchBuddy-5.1.1-x86_64.AppImage`
          - `./ResearchBuddy-5.1.1-x86_64.AppImage`
          - Universal Linux executable - works on all distros!
          
          ---
          
          ## ✨ What's New in 5.1.1
          
          - ✅ **Universal macOS installer** - Works on Intel and Apple Silicon
          - ✅ **Linux AppImage** - Single-file Linux executable for all distros
          - ✅ **Fixed read-only filesystem errors** on macOS
          - ✅ **Updated copyright** to Michael Todd Edwards
          - ✅ **Auto-loads Quick Start guide** on first run
          - ✅ **Improved About dialog** with license and GitHub info
          
          ## 🎯 Features
          
          - Professional PDF viewer with text selection
          - AI-assisted positionality detection (optional - requires OpenAI API key)
          - Manual analysis mode (works without any API keys)
          - Evidence collection and quote extraction
          - GitHub integration for training reports
          - Secure configuration management
          
          ## 📜 License
          
          Creative Commons Attribution-NonCommercial 4.0  
          © 2025 Michael Todd Edwards (OhioMathTeacher)  
          Academic and educational use freely permitted.
          
          ---
          
          **Perfect for Graduate Assistants - No Python, no terminal, no setup!**
