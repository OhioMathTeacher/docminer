name: ğŸš€ Build Research Buddy Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  packages: read

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            name: ResearchBuddy-linux
          - os: windows-latest
            platform: windows  
            name: ResearchBuddy-windows
          - os: macos-latest
            platform: macos
            name: ResearchBuddy-macos

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: ğŸ”¨ Build Windows Executable  
      if: matrix.platform == 'windows'
      run: |
        python -m PyInstaller --onefile --noconsole --name "ResearchBuddy" enhanced_training_interface.py
        mkdir release
        copy dist\ResearchBuddy.exe release\
        copy README.md release\
        copy docs\QUICK_START_FOR_GAS.md release\

    - name: ğŸ”¨ Build Linux Executable
      if: matrix.platform == 'linux'
      run: |
        python -m PyInstaller --onefile --name "ResearchBuddy" enhanced_training_interface.py
        mkdir release
        cp dist/ResearchBuddy release/
        cp README.md release/
        cp docs/QUICK_START_FOR_GAS.md release/
        chmod +x release/ResearchBuddy

    - name: ğŸ”¨ Build macOS Executable (Apple Silicon)
      if: matrix.platform == 'macos'
      run: |
        echo "Building for Apple Silicon/ARM64..."
        python -m PyInstaller build_files/ResearchBuddy5.2.spec \
          --distpath ./dist \
          --workpath ./build \
          --clean \
          --noconfirm
        
        echo "Verifying architecture..."
        file dist/ResearchBuddy5.2.app/Contents/MacOS/ResearchBuddy5.2
        
        echo "Creating DMG..."
        mkdir -p dmg-temp
        cp -R dist/ResearchBuddy5.2.app dmg-temp/
        ln -s /Applications dmg-temp/Applications
        
        hdiutil create \
          -volname "ResearchBuddy 5.2" \
          -srcfolder dmg-temp \
          -ov -format UDZO \
          ResearchBuddy-5.2.dmg
        
        rm -rf dmg-temp
        
        echo "DMG created successfully!"
        ls -lh ResearchBuddy-5.2.dmg

    - name: ğŸ“¦ Create Package
      shell: bash
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cd release
          7z a "../${{ matrix.name }}.zip" *
        elif [ "${{ matrix.platform }}" = "macos" ]; then
          # DMG already created, just rename it
          mv ResearchBuddy-5.2.dmg ${{ matrix.name }}.dmg
        else
          cd release
          tar -czf "../${{ matrix.name }}.tar.gz" *
        fi

    - name: ğŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: ${{ matrix.name }}.*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ Checkout (for release notes)
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ğŸ“‹ Prepare Release Files
      run: |
        mkdir -p release-files
        # Find all actual files (not directories) in artifacts and copy them
        find artifacts -type f -name "*.dmg" -exec cp {} release-files/ \;
        find artifacts -type f -name "*.zip" -exec cp {} release-files/ \;
        find artifacts -type f -name "*.tar.gz" -exec cp {} release-files/ \;
        echo "ğŸ“‹ Release files prepared:"
        ls -lh release-files/

    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v2
      with:
        draft: false
        prerelease: false
        make_latest: true
        files: release-files/*
        fail_on_unmatched_files: true
        generate_release_notes: false
        body: |
          # ğŸš€ Research Buddy 5.2 - Critical Upload Fix
          
          **Professional installers for all platforms with fixed GitHub upload functionality!**
          
          ## ğŸ“¥ Downloads
          
          ### macOS ğŸ
          **ResearchBuddy-macos.dmg**
          - Double-click DMG â†’ Drag app to Applications â†’ Done!
          - Works on both Intel and Apple Silicon Macs
          
          ### Windows ğŸªŸ
          **ResearchBuddy-windows.zip**
          - Extract â†’ Double-click `.exe` â†’ Run!
          - If Windows Defender warns: Click "More info" â†’ "Run anyway"
          
          ### Linux ğŸ§
          **ResearchBuddy-linux.tar.gz**
          - Extract and run the executable
          - Universal Linux executable - works on all distros!
          
          ---
          
          ## âœ¨ What's New in 5.2
          
          - ğŸ”§ **CRITICAL FIX**: Upload now works in AppImage/executables (uses GitHub REST API instead of git commands)
          - ğŸ“ **Better filenames**: Training reports now named `Reviewer_Author_Decision_Timestamp`
          - ğŸ¨ **UI improvements**: Fixed truncated labels, removed duplicate dialogs
          - âš™ï¸ **First-time setup**: Configuration dialog appears automatically on first launch
          - ğŸ“š **Better documentation**: Comprehensive setup guides for all platforms
          
          ## ğŸ¯ Features
          
          - Professional PDF viewer with text selection
          - AI-assisted positionality detection (optional - requires OpenAI API key)
          - Manual analysis mode (works without any API keys)
          - Evidence collection and quote extraction  
          - GitHub integration for training reports (NOW WORKING IN EXECUTABLES!)
          - Secure configuration management
          
          ## ğŸ“œ License
          
          Creative Commons Attribution-NonCommercial 4.0  
          Â© 2025 Michael Todd Edwards (OhioMathTeacher)  
          Academic and educational use freely permitted.
          
          ---
          
          **Perfect for Graduate Assistants - No Python, no terminal, no setup!**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“Š Release Summary
      run: |
        echo "ğŸ‰ Release Created Successfully!"
        echo "ğŸ“¦ Files included:"
        ls -lh release-files/
        echo ""
        echo "ğŸ”— View release at: ${{ github.server_url }}/${{ github.repository }}/releases"
