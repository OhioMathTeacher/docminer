name: 🚀 Build Research Buddy 3.1 Executables

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v3.1.0
    branches:
      - main  # Also build on main branch pushes
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            executable: ResearchBuddy3.1
          - os: windows-latest
            platform: windows
            arch: x64
            executable: ResearchBuddy3.1.exe
          - os: macos-latest
            platform: macos
            arch: universal
            executable: ResearchBuddy3.1.app

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # Updated to 3.11 for better compatibility
        architecture: x64

    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: 🔨 Build Executable (Linux/Windows)
      if: matrix.platform != 'macos'
      run: |
        python -m PyInstaller --onefile --windowed \
          --name "${{ matrix.executable }}" \
          --distpath ./dist \
          enhanced_training_interface.py

    - name: 🔨 Build Executable (macOS Universal)
      if: matrix.platform == 'macos'
      run: |
        python -m PyInstaller --onedir --windowed \
          --target-arch universal2 \
          --name "ResearchBuddy3.1" \
          --osx-bundle-identifier "edu.university.researchbuddy31" \
          --distpath ./dist \
          enhanced_training_interface.py

    - name: 🧪 Test Executable
      shell: bash
      run: |
        # Basic executable test (check if it exists and is executable)
        if [ "${{ matrix.platform }}" = "macos" ]; then
          if [ -d "./dist/ResearchBuddy3.1.app" ]; then
            echo "✅ macOS app bundle created successfully"
            ls -la "./dist/ResearchBuddy3.1.app"
          else
            echo "❌ macOS app bundle not found"
            exit 1
          fi
        else
          if [ -f "./dist/${{ matrix.executable }}" ]; then
            echo "✅ Executable created successfully"
            ls -la "./dist/${{ matrix.executable }}"
          else
            echo "❌ Executable not found"
            exit 1
          fi
        fi

    - name: 📦 Create Distribution Package
      shell: bash
      run: |
        mkdir -p release
        
        # Copy executable
        if [ "${{ matrix.platform }}" = "macos" ]; then
          cp -r "./dist/ResearchBuddy3.1.app" release/
        else
          cp "./dist/${{ matrix.executable }}" release/
        fi
        
        # Copy essential files
        cp README.md release/
        cp QUICK_START_FOR_GAS.md release/
        
        # Create platform-specific archive
        if [ "${{ matrix.platform }}" = "windows" ]; then
          # Windows: Create ZIP
          cd release
          powershell Compress-Archive -Path "*" -DestinationPath "../ResearchBuddy3.1-windows.zip"
        elif [ "${{ matrix.platform }}" = "macos" ]; then
          # macOS: Create ZIP with proper permissions
          cd release
          zip -r "../ResearchBuddy3.1-macos.zip" *
        else
          # Linux: Create tar.gz
          cd release
          chmod +x "${{ matrix.executable }}"
          tar -czf "../ResearchBuddy3.1-linux.tar.gz" *
        fi

    - name: 📤 Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ResearchBuddy3.1-${{ matrix.platform }}
        path: |
          ResearchBuddy3.1-*.zip
          ResearchBuddy3.1-*.tar.gz
        retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4

    - name: 📥 Download All Artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: 📋 Prepare Release Assets
      run: |
        mkdir -p release-assets
        find artifacts -name "*.zip" -exec cp {} release-assets/ \;
        find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
        ls -la release-assets/

    - name: 📝 Generate Release Notes
      run: |
        cat > release-notes.md << EOF
        # 🚀 Research Buddy 3.1 Release
        
        ## Enhanced Training Interface with Standalone Executables
        
        **Perfect for Graduate Assistants - No technical setup required!**
        
        ### 📥 Downloads
        - **macOS**: ResearchBuddy3.1-macos.zip (Universal Binary)
        - **Windows**: ResearchBuddy3.1-windows.zip (64-bit)
        - **Linux**: ResearchBuddy3.1-linux.tar.gz (64-bit)
        
        ### ✨ What's New in 3.1
        - **📄 Page Navigation**: Navigate multi-page PDFs with ◀ ▶ buttons
        - **🔧 API Key Management**: Configure OpenAI keys directly in the GUI
        - **🛡️ Better Error Handling**: Helpful instructions when setup needed
        - **📦 Standalone Executables**: Just download, extract, and run!
        
        ### 🎯 Key Features
        - **Professional PDF Viewer**: Built-in viewer with text selection
        - **AI-Assisted Analysis**: Optional OpenAI integration for pre-screening
        - **Manual Analysis Mode**: Works great without AI for complete independence
        - **Evidence Collection**: Easy text selection and quote extraction
        - **GitHub Integration**: Direct upload of training decisions
        
        ### 🚀 Quick Start
        1. Download the file for your operating system
        2. Extract/unzip the files  
        3. Double-click the executable to run
        4. See QUICK_START_FOR_GAS.md for detailed instructions
        
        ### 📊 Perfect for Research Teams
        - No Python installation required
        - No command line knowledge needed
        - Professional interface for academic paper analysis
        - Scales from individual researchers to large institutions
        
        ### 📚 Documentation Included
        - Quick Start Guide for Graduate Assistants
        - Complete setup and usage instructions
        - Troubleshooting and FAQ
        
        For technical support or questions, please open an issue in this repository.
        EOF

    - name: 🏷️ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release-notes.md
        files: release-assets/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 📊 Release Summary
      run: |
        echo "🎉 Release Created Successfully!"
        echo "📦 Assets included:"
        ls -la release-assets/
        echo ""
        echo "🔗 View release at: ${{ github.server_url }}/${{ github.repository }}/releases"